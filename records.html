<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Records</title>
<style>
body{font-family:Segoe UI,Arial,sans-serif;background:#f4f6f8;margin:0}
.header{background:#024379;color:#fff;padding:14px;text-align:center}
.container{max-width:1000px;margin:18px auto;padding:14px}
.controls{margin-bottom:12px}
.btn{padding:10px 14px;border-radius:8px;border:0;background:#0078d7;color:#fff;cursor:pointer;margin-right:8px}
.table{background:#fff;padding:12px;border-radius:8px}
.table table{width:100%;border-collapse:collapse}
.table th{background:#f3f6fb;padding:10px}
.table td{padding:10px;border-bottom:1px solid #eee}
.warn{background:#ff6b6b;color:#fff;padding:6px 8px;border-radius:6px;border:0;cursor:pointer}
.return{position:fixed;left:16px;top:14px;background:#6c757d;color:#fff;border:0;padding:8px 12px;border-radius:8px}
</style>
</head>
<body>
<button class="return" onclick="location.href='dashboard.html'">← Home</button>
<div class="header"><h2>Invoice Records</h2></div>
<div class="container">
  <div class="controls">
    <button class="btn" id="exportBtn">Export CSV</button>
    <button class="btn" id="clearBtn">Clear all</button>
  </div>
  <div class="table">
    <table>
      <thead><tr><th>Invoice#</th><th>Date</th><th>Customer</th><th>Items</th><th style="text-align:right">Total</th><th>Action</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<script>
if(!localStorage.getItem('loggedInUser')) location.href='login.html';
const REC_KEY='records', INV_KEY='inventory';

function load(){
  const rows = document.getElementById('rows'); rows.innerHTML = '';
  const rec = JSON.parse(localStorage.getItem(REC_KEY)||'[]');
  if(!rec.length){ rows.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:18px;color:#666">No records</td></tr>'; return; }
  // newest first
  rec.slice().reverse().forEach((r, idxReverse) => {
    const origIndex = rec.length - 1 - idxReverse;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.number}</td><td>${r.date}</td><td>${r.customer}</td>
      <td>${r.items.map(i=>`${i.name}(${i.qty})`).join(', ')}</td>
      <td style="text-align:right">₱${parseFloat(r.total).toFixed(2)}</td>
      <td>
        <button onclick="reprint(${origIndex})">Reprint</button>
        <button class="warn" onclick="delRecord(${origIndex})">Delete & Rollback</button>
      </td>`;
    rows.appendChild(tr);
  });
}

function reprint(idx){
  const rec = JSON.parse(localStorage.getItem(REC_KEY)||'[]');
  const item = rec[idx];
  if(!item) return;
  localStorage.setItem('pos_latest', JSON.stringify(item));
  window.open('print.html','_blank');
}

function delRecord(idx){
  if(!confirm('Delete this record and restore stock?')) return;
  const rec = JSON.parse(localStorage.getItem(REC_KEY)||'[]');
  const removed = rec.splice(idx,1)[0];
  // rollback stock
  if(removed && removed.items){
    const inv = JSON.parse(localStorage.getItem(INV_KEY)||'[]');
    removed.items.forEach(sold => {
      const i = inv.findIndex(x => x.name === sold.name);
      if(i !== -1){
        inv[i].stock = (inv[i].stock || 0) + (sold.qty || 0);
      } else {
        inv.push({name: sold.name, stock: sold.qty || 0, price: sold.price || 0});
      }
    });
    localStorage.setItem(INV_KEY, JSON.stringify(inv));
  }
  localStorage.setItem(REC_KEY, JSON.stringify(rec));
  load();
}

document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(!confirm('Clear all records?')) return;
  localStorage.removeItem(REC_KEY);
  load();
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const rec = JSON.parse(localStorage.getItem(REC_KEY)||'[]');
  if(!rec.length){ alert('No records to export'); return; }
  const header = ['Invoice#','Date','Customer','Total','Items'];
  const lines = rec.map(r=>{
    const itemsText = r.items.map(it => `${it.name} (${it.qty}x${(it.price||0).toFixed(2)})`).join(' | ');
    const row = [r.number, r.date, r.customer, r.total, itemsText];
    return row.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',');
  });
  const csv = header.join(',') + '\n' + lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'pos_records.csv';
  a.click();
});

load();
</script>
</body>
</html>
